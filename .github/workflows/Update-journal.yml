name: Push Latest Log to Profile

on:
  push:
    paths:
      - '2025/*.md' # Triggers only when you edit files in the 2025 folder
  workflow_dispatch: # Allows you to run it manually to test

jobs:
  update-profile:
    runs-on: ubuntu-latest
    steps:
      # 1. Get the Journal Repo
      - name: Checkout Journal Repo
        uses: actions/checkout@v3
        with:
          path: journal

      # 2. Get the Profile Repo (Using the Secret Token)
      - name: Checkout Profile Repo
        uses: actions/checkout@v3
        with:
          repository: Kugelbyte/Kugelbyte # <--- CHANGE THIS TO YOUR USERNAME
          path: profile
          token: ${{ secrets.Profile_token }}

      # 3. Python Script to find the last entry
      - name: Parse and Update
        run: |
          cd journal
          python3 -c "
          import os
          import datetime

          # --- CONFIGURATION ---
          # Dynamic Year and Month based on today's date
          now = datetime.datetime.now()
          year = now.strftime('%Y') # '2025'
          month = now.strftime('%B') # 'December'
          
          # Target File: 2025/December.md
          file_path = f'{year}/{month}.md'

          # --- LOGIC ---
          if not os.path.exists(file_path):
              print(f'Log file {file_path} not found. Skipping update.')
              exit(0)

          # Read the log file
          with open(file_path, 'r') as f:
              lines = f.readlines()

          # Find the index of the LAST header (starts with #)
          last_header_index = -1
          for i, line in enumerate(lines):
              if line.strip().startswith('#'):
                  last_header_index = i
          
          # Extract content from the last header downwards
          if last_header_index != -1:
              latest_entry = ''.join(lines[last_header_index:])
          else:
              latest_entry = ''.join(lines) # Fallback

          # Read the Profile README
          readme_path = '../profile/README.md'
          with open(readme_path, 'r') as f:
              readme = f.read()

          # Inject content between markers
          start_marker = ''
          end_marker = ''

          if start_marker in readme and end_marker in readme:
              before = readme.split(start_marker)[0]
              after = readme.split(end_marker)[1]
              
              # HTML formatting for the profile
              # We wrap it in a <details> tag so it looks clean (expandable)
              # or remove <details> tags if you want it always visible.
              formatted_entry = f'<br/><h3>ðŸ”¥ Latest Journal Log ({month} {year})</h3>\n\n{latest_entry}'
              
              final_content = before + start_marker + '\n' + formatted_entry + '\n' + end_marker + after

              with open(readme_path, 'w') as f:
                  f.write(final_content)
              print('Profile README successfully patched.')
          else:
              print('ERROR: Markers not found in profile README.')
          "

      # 4. Save Changes to Profile
      - name: Commit and Push
        run: |
          cd profile
          git config user.name "Journal Bot"
          git config user.email "bot@github.com"
          
          # Only commit if the file actually changed
          if [[ -n $(git status -s) ]]; then
            git add README.md
            git commit -m "Auto-update: Latest Journal Entry"
            git push
          else
            echo "No changes to commit (Profile is already up to date)."
          fi
